import numpy as np
import pandas as pd
import pathlib

from climada.entity import ImpactFunc, ImpactFuncSet
from climada.entity.impact_funcs.trop_cyclone import ImpfTropCyclone


PATH_CSV_TC_CAPRA_BEM = pathlib.Path(
    str(pathlib.Path(__file__).parent.resolve()), 'data/CAPRA_TO_BEM_TC_WIND_IMPACT_FUNCTIONS.csv')

# =============================================================================
# Conversion from PAGER building classification to CAPRA building classification (aggregated before)
# =============================================================================
DICT_CAPRA2BEM = {
    'C1' : 'C1',
    'C2' : 'C2',
    'C3' : 'C3',
    'RM2' : 'RM2',
    'S1' : 'S1',
    'S4' : 'S4',
    'S5' : 'S5',
    'W' : 'W',
    'A' : 'A',
    'C' : 'C',
    'C1H' : 'C1H',
    'C1L' : 'C1L',
    'C1M' : 'C1M',
    'C2L' : 'C2L',
    'C3L' : 'C3L',
    'DS3' : 'DS3',
    'INF' : 'INF',
    'MH' : 'MH',
    'PC1' : 'PC1',
    'PC2L' : 'PC2L',
    'RM' : 'RM',
    'RM1L' : 'RM1L',
    'RM2L' : 'RM2L',
    'RM2M' : 'RM2M',
    'S' : 'S',
    'S1H' : 'S1H',
    'S1L' : 'S1L',
    'S1M' : 'S1M',
    'S2L' : 'S2L',
    'S3' : 'S3',
    'S4H' : 'S4H',
    'S4L' : 'S4L',
    'S4M' : 'S4M',
    'S5L' : 'S5L',
    'UCB' : 'UCB',
    'UFB' : 'UFB',
    'UFB3' : 'UFB3',
    'W1' : 'W1',
    'W2' : 'W2',
    'S2' : 'S2',
    'A2' : 'A2',
    'C3M' : 'C3M',
    'CH' : 'CH',
    'CL' : 'CL',
    'CM' : 'CM',
    'DS' : 'DS',
    'DS2' : 'DS2',
    'MS' : 'MS',
    'RM1' : 'RM1',
    'RS' : 'RS',
    'RS1' : 'RS1',
    'RS2' : 'RS2',
    'UFB1' : 'UFB1',
    'UFB2' : 'UFB2',
    'UFB4' : 'UFB4',
    'UNK' : 'UNK',
    'PC' : 'PC',
    'A4' : 'A4',
    'M' : 'M',
    'PC2' : 'PC2',
    'W4' : 'W4',
    'A1' : 'A1',
    'C4' : 'C4',
    'M2' : 'M2',
    'RS3' : 'RS3',
    'DS4' : 'DS4',
    'RS4' : 'RS4',
    'DS1' : 'DS1',
    'RM2H' : 'RM2H',
    'RS5' : 'RS5',
    'RE' : 'RE',
    'A3' : 'A3'
}

DICT_CAPRA_IMPF_TC = {
    'C1' : 1,
    'C2' : 2,
    'C3' : 3,
    'RM2' : 4,
    'S1' : 5,
    'S4' : 6,
    'S5' : 7,
    'W' : 8,
    'A' : 9,
    'C' : 10,
    'C1H' : 11,
    'C1L' : 12,
    'C1M' : 13,
    'C2L' : 14,
    'C3L' : 15,
    'DS3' : 16,
    'INF' : 17,
    'MH' : 18,
    'PC1' : 19,
    'PC2L' : 20,
    'RM' : 21,
    'RM1L' : 22,
    'RM2L' : 23,
    'RM2M' : 24,
    'S' : 25,
    'S1H' : 26,
    'S1L' : 27,
    'S1M' : 28,
    'S2L' : 29,
    'S3' : 30,
    'S4H' : 31,
    'S4L' : 32,
    'S4M' : 33,
    'S5L' : 34,
    'UCB' : 35,
    'UFB' : 36,
    'UFB3' : 37,
    'W1' : 38,
    'W2' : 39,
    'S2' : 40,
    'A2' : 41,
    'C3M' : 42,
    'CH' : 43,
    'CL' : 44,
    'CM' : 45,
    'DS' : 46,
    'DS2' : 47,
    'MS' : 48,
    'RM1' : 49,
    'RS' : 50,
    'RS1' : 51,
    'RS2' : 52,
    'UFB1' : 53,
    'UFB2' : 54,
    'UFB4' : 55,
    'UNK' : 56,
    'PC' : 57,
    'A4' : 58,
    'M' : 59,
    'PC2' : 60,
    'W4' : 61,
    'A1' : 62,
    'C4' : 63,
    'M2' : 64,
    'RS3' : 65,
    'DS4' : 66,
    'RS4' : 67,
    'DS1' : 68,
    'RM2H' : 69,
    'RS5' : 70,
    'RE' : 71,
    'A3' : 72,
}

DICT_PAGER_TCIMPF_CAPRA = {key: DICT_CAPRA_IMPF_TC[value]
                           for key, value in DICT_CAPRA2BEM.items()}


def if_fom_sig_funcs_capra(bldg_sub_type):
    """Return the impact function for a given building subtype."""
    df_impf = pd.read_csv(PATH_CSV_TC_CAPRA_BEM)
    v_thresh = df_impf[df_impf.building_type ==
                             bldg_type][f'v_thresh_median'].values[0]
    v_half = df_impf[df_impf.building_type ==
                           bldg_type][f'v_half_median'].values[0]

    return ImpfTropCyclone.from_emanuel_usa(
        impf_id=DICT_CAPRA_IMPF_TC[f'{bldg_type}'],
        intensity=np.arange(0, 121, 2),
        v_thresh=v_thresh, v_half=v_half, scale=1.0)


IMPF_SET_TC_CAPRA = ImpactFuncSet([if_fom_sig_funcs_capra(bldg_sub)
                                   for bldg_sub in DICT_CAPRA2BEM.keys()])
